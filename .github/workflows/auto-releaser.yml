# SPDX-FileCopyrightText: 2024 Comcast Cable Communications Management, LLC
# SPDX-License-Identifier: Apache-2.0
# @example=## Golang Automatic Patch Releaser Sample
## SPDX-FileCopyrightText: 2024 Comcast Cable Communications Management, LLC
## SPDX-License-Identifier: Apache-2.0
#---
#name: 'Automatically relase patch versions.'
#
#  on:
#    schedule: # Run every day at 12:00 UTC
#      - cron: '0 12 * * *'
#    workflow_dispatch:
#
#  jobs:
#    release:
#      uses: xmidt-org/shared-go/.github/workflows/ci.yml@826aa545bb56f6c7c551d44febb420c0293c8bff # v4.2.0
#      secrets: inherit
---
name: 'Auto Releaser'

on:
  workflow_call:
    inputs:

      branch:
        description: 'Branch to release from.'
        type: string
        required: false
        default: 'main'

      patch-list:
        description: 'Comma separated list of commit types that should trigger a patch release.'
        type: string
        required: false
        default: >
          bugfix, Bugfix, BugFix, BUGFIX,
          chore, Chore, CHORE,
          fix, Fix, FIX,
          perf,
          refactor, Refactor, REFACTOR,
          test, Test, TEST,
          tests, Tests, TESTS

      minor-list:
        description: 'The specific minor prefix names to use for minors.'
        type: string
        required: false
        default: feat, Feat, FEAT, feature, Feature, FEATURE

      which:
        description: Create a 'release' or 'tag'.
        type: string
        required: false
        default: tag

jobs:
  release:
    permissions: write-all
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0

      - name: Get Next Version
        id: semver
        uses: ietf-tools/semver-action@c90370b2958652d71c06a3484129a4d423a6d8a8 # v1.11.0
        with:
          token:                 ${{ github.token }}
          branch:                ${{ inputs.branch }}
          patchList:             ${{ inputs.patch-list }}
          minorList:             ${{ inputs.minor-list }}
          noVersionBumpBehavior: silent
          noNewCommitBehavior:   silent

      - name: No Release Needed
        if: |
          steps.semver.outputs.next == ''
        run: echo "No release needed."

      - name: Create Release
        if: |
          steps.semver.outputs.next != '' &&
          inputs.which == 'release'
        uses: ncipollo/release-action@b7eabc95ff50cbeeedec83973935c8f306dfcd0b # v1.20.0
        with:
          name:   ${{ steps.semver.outputs.next }}
          tag:    ${{ steps.semver.outputs.next }}
          commit: ${{ github.sha }}
          token:  ${{ github.token }}

      - name: Create Tag
        if: |
          steps.semver.outputs.next != '' &&
          inputs.which == 'tag'
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: 'refs/tags/${{ steps.semver.outputs.next }}',
              sha: context.sha
            })

      - name: Failure
        if: |
          steps.semver.outputs.next != '' &&
          inputs.which != 'release' &&
          inputs.which != 'tag'
        run: |
          echo "No new version found."
          exit
